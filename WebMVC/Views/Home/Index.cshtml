@model WebMVC.Models.Book.PaginatedResultModel<WebMVC.Models.Book.BookViewModel>

@{
ViewData["Title"] = "Books";
}

<h1 class="display-4 text-center mb-4">Books</h1>

<div class="mb-4 position-relative" style="max-width: 720px; margin: 0 auto;">
    <div class="input-group input-group-lg">
        <span class="input-group-text">🔎</span>
        <input id="search"
               type="text"
               class="form-control"
               placeholder="Search by title, genre, author or publisher…"
               autocomplete="off" />
        <button id="clear" type="button" class="btn btn-outline-secondary">✕</button>
    </div>

    <div id="dropdown"
         class="shadow bg-white border rounded-3 mt-2"
         style="display:none; position:absolute; z-index: 2000; width: 100%; overflow:hidden;">
        <div id="dropdownInner"></div>
    </div>

    <small class="text-muted d-block mt-2">
        Tip: try something like <code>king</code>, <code>fantasy</code>, <code>rowling</code>…
    </small>
</div>

<div class="container p-1 border rounded-3 shadow-sm bg-light" style="max-width: 1100px">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-2">
        @foreach (var book in Model.Items)
        {
            <div class="col book-item"
                 data-title="@book.Title"
                 data-author="@book.AuthorName"
                 data-publisher="@book.PublisherName"
                 data-genres="@string.Join(" ", book.Genres.Select(g => g.GenreName))">

                <div class="card h-100 border rounded-3 shadow-sm book-card">
                    <a asp-controller="Book"
                       asp-action="Detail"
                       asp-route-id="@book.Id"
                       class="text-decoration-none text-dark">
                    
                        <div class="card-img-wrapper pt-1 px-1">
                            <img src="~/cover-images/@book.CoverImageName"
                                 class="book-cover"
                                 alt="failed to load cover image"/>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-2">@book.Title</h5>

                            <p class="card-text mb-0">
                                <span class="fw-semibold"></span> @book.AuthorName
                            </p>

                            <p class="card-text mb-2">
                                <strong>@book.Price.ToString("C")</strong>
                            </p>

                            <p class="card-text mb-2 small">
                                @Html.Raw(string.Join(", ", book.Genres.Select(g =>
                                    g.IsPrimary
                                        ? $"<span style='font-weight:bold; color:#d32f2f; background-color:#ffe5e5; padding:2px 6px; border-radius:4px;'>{g.GenreName}</span>"
                                        : $"<span style='color:#555; padding:2px 6px; border-radius:4px;'>{g.GenreName}</span>")))
                            </p>

                            <p class="card-text mb-1 small text-muted">
                                <span class="fw-semibold"></span> @book.PublisherName
                            </p>
                        </div>
                    </a>
                </div>
            </div>
        }
    </div>
    @if (Model.TotalPages > 1)
    {
        <nav class="mt-4 d-flex justify-content-center" aria-label="Books pagination">
            <ul class="pagination mb-0">
                <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                    <a class="page-link" asp-action="Index" asp-route-page="@(Model.PageIndex - 1)" asp-route-pageSize="@Model.PageSize">Prev</a>
                </li>

                <li class="page-item disabled">
                    <span class="page-link">Page @Model.PageIndex / @Model.TotalPages</span>
                </li>

                <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                    <a class="page-link" asp-action="Index" asp-route-page="@(Model.PageIndex + 1)" asp-route-pageSize="@Model.PageSize">Next</a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Scripts {
<script>
    (() => {
        const input = document.getElementById("search");
        const clearBtn = document.getElementById("clear");
        const dd = document.getElementById("dropdown");
        const ddInner = document.getElementById("dropdownInner");

        const items = Array.from(document.querySelectorAll(".book-item"));
        let timer = null;

        const esc = (s) => (s ?? "").toString()
            .replaceAll("&", "&amp;").replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;").replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");

        const show = () => dd.style.display = "block";
        const hide = () => dd.style.display = "none";

        const applyFilterToGrid = (q) => {
            const needle = (q ?? "").trim().toLowerCase();

            if (!needle) {
                items.forEach(i => i.style.display = "");
                return;
            }

            items.forEach(i => {
                const hay = (
                    (i.dataset.title || "") + " " +
                    (i.dataset.author || "") + " " +
                    (i.dataset.publisher || "") + " " +
                    (i.dataset.genres || "")
                ).toLowerCase();

                i.style.display = hay.includes(needle) ? "" : "none";
            });
        };

        const renderSection = (label, itemsHtml) => `
                <div class="px-3 pt-3 pb-2 small text-uppercase text-muted fw-semibold">${esc(label)}</div>
                ${itemsHtml || `<div class="px-3 pb-2 text-muted small">None</div>`}
            `;

        const render = (data) => {
            const titles = (data.titles || []).map(x => `
                    <a class="item d-block text-decoration-none text-dark px-3 py-2"
                       href="/Book/Detail/${x.id}">
                        <div class="fw-semibold">${esc(x.text)}</div>
                        <div class="text-muted small">${esc(x.meta)}</div>
                    </a>
                `).join("");

            const genres = (data.genres || []).map(x => `
                    <button type="button"
                            class="item w-100 text-start border-0 bg-white px-3 py-2"
                            data-filter="${esc(x.text)}">
                        <div class="fw-semibold">${esc(x.text)}</div>
                        <div class="text-muted small">Genre</div>
                    </button>
                `).join("");

            const ap = (data.authorPublishers || []).map(x => `
                    <button type="button"
                            class="item w-100 text-start border-0 bg-white px-3 py-2"
                            data-filter="${esc(x.text)}">
                        <div class="fw-semibold">${esc(x.text)}</div>
                        <div class="text-muted small">${esc(x.kind === "publisher" ? "Publisher" : "Author")}</div>
                    </button>
                `).join("");

            return `
                    ${renderSection("Books", titles)}
                    <div class="border-top"></div>
                    ${renderSection("Genres", genres)}
                    <div class="border-top"></div>
                    ${renderSection("Autor / Publisher", ap)}
                `;
        };

        const wireFilterButtons = () => {
            ddInner.querySelectorAll("button[data-filter]").forEach(btn => {
                btn.addEventListener("click", () => {
                    const value = btn.getAttribute("data-filter") || "";
                    input.value = value;
                    hide();
                    applyFilterToGrid(value);
                    input.focus();
                });
            });
        };

        const load = async (q) => {
            const query = (q ?? "").trim();

            if (query.length < 2) {
                ddInner.innerHTML = "";
                hide();
                return;
            }

            try {
                const resp = await fetch(`/Search/Suggestions?q=${encodeURIComponent(query)}`);
                if (!resp.ok) {
                    hide();
                    return;
                }

                const data = await resp.json();
                ddInner.innerHTML = render(data);
                wireFilterButtons();
                show();
            } catch {
                hide();
            }
        };

        input.addEventListener("input", () => {
            clearTimeout(timer);
            timer = setTimeout(() => load(input.value), 200);
        });

        input.addEventListener("focus", () => {
            if ((input.value || "").trim().length >= 2) {
                load(input.value);
            }
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                input.value = "";
                hide();
                applyFilterToGrid("");
            }

            if (e.key === "Enter") {
                e.preventDefault();
                applyFilterToGrid(input.value);
                hide();
            }
        });

        clearBtn.addEventListener("click", () => {
            input.value = "";
            hide();
            applyFilterToGrid("");
            input.focus();
        });

        document.addEventListener("click", (e) => {
            if (!dd.contains(e.target) && e.target !== input) {
                hide();
            }
        });
    })();
</script>
}

<style>
    .item:hover { background: #f6f7f9; }
    .item:active { background: #c5c6c8; }

    .card-img-wrapper {
        text-align: center;
    }

    .book-cover {
        display: block;
        width: 70%;
        aspect-ratio: 2 / 3;
        object-fit: contain;
        margin: 0 auto;
    }
    .book-card {
        max-width: 280px;
        width: 100%;
    }

</style>
